// Employee related models

model Employee {
  id                     String          @id @default(uuid())
  userId                 String?         @unique
  user                   User?           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  employeeId             String          @unique
  employeeName           String
  fatherHusbandName      String
  departmentId           String
  department             Department      @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  subDepartmentId        String?
  subDepartment          SubDepartment?  @relation(fields: [subDepartmentId], references: [id], onDelete: SetNull)
  departmentAsHead       Department?     @relation("DepartmentHead")
  subDepartmentAsHead    SubDepartment?  @relation("SubDepartmentHead")
  employeeGradeId        String
  employeeGrade          EmployeeGrade   @relation(fields: [employeeGradeId], references: [id], onDelete: Restrict)
  attendanceId           String
  designationId          String
  designation            Designation     @relation(fields: [designationId], references: [id], onDelete: Restrict)
  maritalStatusId        String?
  maritalStatus          MaritalStatus?  @relation(fields: [maritalStatusId], references: [id], onDelete: Restrict)
  employmentStatusId     String?
  employmentStatus       EmployeeStatus? @relation(fields: [employmentStatusId], references: [id], onDelete: Restrict)
  probationExpiryDate    DateTime?
  cnicNumber             String          @unique
  cnicExpiryDate         DateTime?
  lifetimeCnic           Boolean         @default(false)
  joiningDate            DateTime?
  dateOfBirth            DateTime?
  nationality            String
  gender                 String
  contactNumber          String
  emergencyContactNumber String?
  emergencyContactPerson String?
  personalEmail          String?
  officialEmail          String?         @unique
  countryId              String
  country                Country         @relation(fields: [countryId], references: [id], onDelete: Restrict)
  stateId                String
  state                  State           @relation(fields: [stateId], references: [id], onDelete: Restrict)
  cityId                 String
  city                   City            @relation(fields: [cityId], references: [id], onDelete: Restrict)
  area                   String?
  employeeSalary         Decimal
  eobi                   Boolean         @default(false)
  eobiId                 String? // EOBI ID like "0800B656361"
  eobiCode               String? // EOBI Code like "AA001"
  eobiNumber             String?
  eobiDocumentUrl        String?
  documentUrls           Json?

  providentFund                   Boolean                          @default(false)
  overtimeApplicable              Boolean                          @default(false)
  daysOff                         String?
  reportingManager                String?
  workingHoursPolicyId            String
  workingHoursPolicy              WorkingHoursPolicy               @relation(fields: [workingHoursPolicyId], references: [id], onDelete: Restrict)
  locationId                      String?
  location                        Location?                        @relation(fields: [locationId], references: [id], onDelete: Restrict)
  allocationId                    String?
  allocation                      Allocation?                      @relation(fields: [allocationId], references: [id], onDelete: Restrict)
  leavesPolicyId                  String
  leavesPolicy                    LeavesPolicy                     @relation(fields: [leavesPolicyId], references: [id], onDelete: Restrict)
  allowRemoteAttendance           Boolean                          @default(false)
  currentAddress                  String?
  permanentAddress                String?
  bankName                        String
  accountNumber                   String
  accountTitle                    String
  status                          String                           @default("active")
  // Rejoining tracking
  isRejoined                      Boolean                          @default(false)
  originalJoiningDate             DateTime? // First ever joining date (preserved on rejoin)
  lastExitDate                    DateTime? // Date when employee last left
  rejoinCount                     Int                              @default(0)
  createdAt                       DateTime                         @default(now())
  updatedAt                       DateTime                         @updatedAt
  qualifications                  EmployeeQualification[]
  attendances                     Attendance[]
  exitClearances                  ExitClearance[]
  attendanceRequestQueries        AttendanceRequestQuery[]
  attendanceExemptions            AttendanceExemption[]
  equipmentAssignments            EmployeeEquipment[]
  leaveApplications               LeaveApplication[]
  policyAssignments               WorkingHoursPolicyAssignment[]
  rejoiningHistory                EmployeeRejoiningHistory[]
  requestForwardingApprovalLevels RequestForwardingApprovalLevel[] @relation("RequestForwardingSpecificEmployee")
  allowances                      Allowance[]
  deductions                      Deduction[]
  advanceSalaries                 AdvanceSalary[]
  loanRequests                    LoanRequest[]
  overtimeRequests                OvertimeRequest[]                @relation("OvertimeRequestEmployee")
  increments                      Increment[]                      @relation("IncrementEmployee")
  leaveEncashments                LeaveEncashment[]

  bonuses                     Bonus[]                              @relation("BonusEmployee")
  rebates                     Rebate[]
  payrollDetails              PayrollDetail[]
  socialSecurityRegistrations SocialSecurityEmployeeRegistration[]
  socialSecurityContributions SocialSecurityContribution[]
  pfWithdrawals               PFWithdrawal[]
}

model EmployeeRejoiningHistory {
  id                    String   @id @default(uuid())
  employeeId            String
  employee              Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  previousEmployeeId    String // Old employee ID before rejoin
  newEmployeeId         String // New employee ID after rejoin
  previousAttendanceId  String // Old attendance ID
  newAttendanceId       String // New attendance ID
  previousExitDate      DateTime // When employee left
  rejoiningDate         DateTime // When employee rejoined
  previousDepartmentId  String?
  newDepartmentId       String?
  previousDesignationId String?
  newDesignationId      String?
  previousSalary        Decimal?
  newSalary             Decimal?
  // Comprehensive change tracking - stores all field changes
  previousValues        Json? // Complete snapshot of employee data before rejoin
  newValues             Json? // Complete snapshot of employee data after rejoin
  changedFields         Json? // Array of field names that were changed
  remarks               String?
  createdById           String?
  createdBy             User?    @relation(fields: [createdById], references: [id])
  createdAt             DateTime @default(now())

  @@index([employeeId])
  @@index([rejoiningDate])
}

model EmployeeQualification {
  id              String        @id @default(uuid())
  employeeId      String
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  qualificationId String
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Restrict)
  instituteId     String?
  institute       Institute?    @relation(fields: [instituteId], references: [id], onDelete: SetNull)
  cityId          String?
  city            City?         @relation(fields: [cityId], references: [id], onDelete: SetNull)
  stateId         String?
  state           State?        @relation(fields: [stateId], references: [id], onDelete: SetNull)
  year            Int?
  grade           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([employeeId])
}

model EmployeeEquipment {
  id           String    @id @default(uuid())
  employeeId   String
  employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  equipmentId  String
  equipment    Equipment @relation(fields: [equipmentId], references: [id], onDelete: Restrict)
  productId    String // Company's product/item tracking ID (e.g., "INLP-48", "MOB-123", "KEY-456", "VEH-789")
  assignedDate DateTime  @default(now())
  returnedDate DateTime?
  status       String    @default("assigned") // assigned, returned, damaged, lost
  notes        String?
  metadata     Json? // Flexible storage for any equipment-specific data (IMEI, MAC address, registration number, etc.)

  // Assignment tracking
  assignedById String?
  assignedBy   User?    @relation("EquipmentAssignedBy", fields: [assignedById], references: [id])
  returnedById String?
  returnedBy   User?    @relation("EquipmentReturnedBy", fields: [returnedById], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([employeeId])
  @@index([equipmentId])
  @@index([status])
  @@index([productId])
}
