// Payroll related models

model Allowance {
  id              String        @id @default(uuid())
  employeeId      String
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  allowanceHeadId String
  allowanceHead   AllowanceHead @relation(fields: [allowanceHeadId], references: [id], onDelete: Restrict)
  amount          Decimal       @db.Decimal(10, 2)
  month           String // Format: "01" to "12"
  year            String // Format: "YYYY"
  date            DateTime // Full date for reference
  isTaxable       Boolean       @default(false)
  taxPercentage   Decimal?      @db.Decimal(5, 2) // Percentage (0-100)
  notes           String?
  status          String        @default("active") // active, inactive, cancelled
  createdById     String?
  createdBy       User?         @relation("AllowanceCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?         @relation("AllowanceUpdatedBy", fields: [updatedById], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([employeeId, allowanceHeadId, month, year]) // One allowance per employee per type per month-year
  @@index([employeeId])
  @@index([allowanceHeadId])
  @@index([month, year])
  @@index([status])
}

model Deduction {
  id              String        @id @default(uuid())
  employeeId      String
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  deductionHeadId String
  deductionHead   DeductionHead @relation(fields: [deductionHeadId], references: [id], onDelete: Restrict)
  amount          Decimal       @db.Decimal(10, 2)
  month           String // Format: "01" to "12"
  year            String // Format: "YYYY"
  date            DateTime // Full date for reference
  isTaxable       Boolean       @default(false)
  taxPercentage   Decimal?      @db.Decimal(5, 2) // Percentage (0-100)
  notes           String?
  status          String        @default("active") // active, inactive, cancelled
  createdById     String?
  createdBy       User?         @relation("DeductionCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?         @relation("DeductionUpdatedBy", fields: [updatedById], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([employeeId, deductionHeadId, month, year]) // One deduction per employee per type per month-year
  @@index([employeeId])
  @@index([deductionHeadId])
  @@index([month, year])
  @@index([status])
}

model AdvanceSalary {
  id                 String    @id @default(uuid())
  employeeId         String
  employee           Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  amount             Decimal   @db.Decimal(10, 2)
  neededOn           DateTime // When the advance salary is needed
  deductionMonth     String // Format: "01" to "12"
  deductionYear      String // Format: "YYYY"
  deductionMonthYear String // Format: "YYYY-MM" for easy querying
  reason             String    @db.Text // Detailed reason for advance salary
  approvalStatus     String    @default("pending") // pending, approved, rejected
  approvedById       String?
  approvedBy         User?     @relation("AdvanceSalaryApprovedBy", fields: [approvedById], references: [id])
  approvedAt         DateTime?
  rejectionReason    String?   @db.Text // Reason if rejected
  status             String    @default("pending") // pending, active, completed, cancelled, rejected
  createdById        String?
  createdBy          User?     @relation("AdvanceSalaryCreatedBy", fields: [createdById], references: [id])
  updatedById        String?
  updatedBy          User?     @relation("AdvanceSalaryUpdatedBy", fields: [updatedById], references: [id])
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([employeeId])
  @@index([deductionMonth, deductionYear])
  @@index([deductionMonthYear])
  @@index([approvalStatus])
  @@index([status])
  @@index([neededOn])
}

model OvertimeRequest {
  id                    String   @id @default(uuid())
  employeeId            String
  employee              Employee @relation("OvertimeRequestEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  overtimeType          String   // "weekday" | "holiday"
  title                 String
  description           String?
  date                  DateTime
  weekdayOvertimeHours  Decimal  @db.Decimal(5, 2) @default(0)
  holidayOvertimeHours  Decimal  @db.Decimal(5, 2) @default(0)
  status                String   @default("pending") // pending, approved, rejected, cancelled
  approval1             String?  // First approval status
  approval2             String?  // Second approval status
  createdById           String?
  createdBy             User?    @relation("OvertimeRequestCreatedBy", fields: [createdById], references: [id])
  updatedById           String?
  updatedBy             User?    @relation("OvertimeRequestUpdatedBy", fields: [updatedById], references: [id])
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([employeeId])
  @@index([overtimeType])
  @@index([status])
  @@index([date])
}

model Increment {
  id                String        @id @default(uuid())
  employeeId        String
  employee          Employee      @relation("IncrementEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  employeeGradeId   String?
  employeeGrade     EmployeeGrade? @relation("IncrementEmployeeGrade", fields: [employeeGradeId], references: [id], onDelete: SetNull)
  designationId     String?
  designation       Designation?  @relation("IncrementDesignation", fields: [designationId], references: [id], onDelete: SetNull)
  incrementType     String        // "Increment" | "Decrement"
  incrementAmount   Decimal?      @db.Decimal(10, 2)
  incrementPercentage Decimal?   @db.Decimal(5, 2) // Percentage (0-100)
  incrementMethod   String        // "Amount" | "Percent"
  salary            Decimal       @db.Decimal(10, 2)
  promotionDate     DateTime
  currentMonth      String        // Format: "01" to "12"
  monthsOfIncrement Int
  notes             String?
  status            String        @default("active") // active, inactive, cancelled
  createdById       String?
  createdBy         User?         @relation("IncrementCreatedBy", fields: [createdById], references: [id])
  updatedById       String?
  updatedBy         User?         @relation("IncrementUpdatedBy", fields: [updatedById], references: [id])
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([employeeId])
  @@index([employeeGradeId])
  @@index([designationId])
  @@index([incrementType])
  @@index([currentMonth])
  @@index([status])
}
model Bonus {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation("BonusEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  bonusTypeId     String
  bonusType       BonusType @relation("BonusBonusType", fields: [bonusTypeId], references: [id], onDelete: Restrict)
  amount          Decimal   @db.Decimal(10, 2) // Calculated amount for this employee
  calculationType String    // "Amount" | "Percentage" (from BonusType)
  percentage      Decimal?  @db.Decimal(5, 2) // Percentage used (if calculationType is "Percentage")
  bonusMonth      String    // Format: "01" to "12"
  bonusYear       String    // Format: "YYYY"
  bonusMonthYear  String    // Format: "YYYY-MM" for easy querying
  paymentMethod   String    @default("with_salary") // "with_salary" | "separately"
  adjustmentMethod String   @default("distributed-remaining-months") // "distributed-remaining-months" | "deduct-current-month"
  notes           String?   @db.Text
  status          String    @default("active") // active, inactive, cancelled
  createdById     String?
  createdBy       User?     @relation("BonusCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?     @relation("BonusUpdatedBy", fields: [updatedById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([employeeId, bonusTypeId, bonusMonthYear]) // One bonus per employee per type per month-year
  @@index([employeeId])
  @@index([bonusTypeId])
  @@index([bonusMonth, bonusYear])
  @@index([bonusMonthYear])
  @@index([status])
  @@index([paymentMethod])
}

model Payroll {
  id            String          @id @default(uuid())
  month         String          // "01" to "12"
  year          String          // "YYYY"
  totalAmount   Decimal         @db.Decimal(15, 2)
  status        String          @default("draft") // draft, processed, approved
  generatedAt   DateTime        @default(now())
  generatedById String?
  generatedBy   User?           @relation("PayrollGeneratedBy", fields: [generatedById], references: [id])
  details       PayrollDetail[]
  
  @@unique([month, year])
}

model PayrollDetail {
  id                   String   @id @default(uuid())
  payrollId            String
  payroll              Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employeeId           String
  employee             Employee @relation(fields: [employeeId], references: [id])
  
  basicSalary          Decimal  @db.Decimal(10, 2)
  totalAllowances      Decimal  @db.Decimal(10, 2) @default(0)
  
  // Deductions
  totalDeductions      Decimal  @db.Decimal(10, 2) @default(0) // Sum of Head deductions
  attendanceDeduction  Decimal  @db.Decimal(10, 2) @default(0) // Lates + Absents
  loanDeduction        Decimal  @db.Decimal(10, 2) @default(0)
  advanceSalaryDeduction Decimal @db.Decimal(10, 2) @default(0)
  eobiDeduction        Decimal  @db.Decimal(10, 2) @default(0)
  providentFundDeduction Decimal @db.Decimal(10, 2) @default(0)
  taxDeduction         Decimal  @db.Decimal(10, 2) @default(0) // Final calculated tax
  
  // Additions
  overtimeAmount       Decimal  @db.Decimal(10, 2) @default(0)
  bonusAmount          Decimal  @db.Decimal(10, 2) @default(0)
  
  grossSalary          Decimal  @db.Decimal(10, 2)
  netSalary            Decimal  @db.Decimal(10, 2)
  
  paymentStatus        String   @default("pending") // pending, paid
  paymentDate          DateTime?
  
  @@unique([payrollId, employeeId])
}

